# Refinement Tracking: Observability Stack Integration

## FRD Location
`/home/ty/workspace/project-starter/docs/futures/observability-stack-integration.md`

## Analysis Progress
- [x] Initial codebase scan
- [x] Backend support analysis
- [x] Frontend patterns analysis (N/A - explicitly out of scope per OOS-1)
- [x] Integration points analysis
- [x] Infrastructure needs analysis
- [x] Template conditional rendering analysis
- [x] Testing infrastructure analysis (covered in FRD Testing Strategy section)
- [x] Final consolidation

## Current Focus
Final consolidation - adding Implementation Analysis sections to FRD

## Findings Summary

### Initial Codebase Scan (Complete)

**Project Structure:**
- **Source**: `/home/ty/workspace/project-starter/implementation-manager/` - Contains reference implementation
- **Target**: `/home/ty/workspace/project-starter/template/{{cookiecutter.project_slug}}/` - Cookiecutter template

**Source Files Identified:**
| File | Location | Purpose |
|------|----------|---------|
| `observability.py` | `implementation-manager/backend/observability.py` | Backend instrumentation module |
| `prometheus.yml` | `implementation-manager/observability/prometheus/prometheus.yml` | Prometheus scrape config |
| `loki-config.yml` | `implementation-manager/observability/loki/loki-config.yml` | Loki storage config |
| `promtail-config.yml` | `implementation-manager/observability/promtail/promtail-config.yml` | Log collection config |
| `tempo.yml` | `implementation-manager/observability/tempo/tempo.yml` | Trace backend config |
| `datasources.yml` | `implementation-manager/observability/grafana/datasources/datasources.yml` | Grafana datasources |
| `dashboards.yml` | `implementation-manager/observability/grafana/dashboards/dashboards.yml` | Dashboard provisioning |
| `backend-dashboard.json` | `implementation-manager/observability/grafana/dashboards/backend-dashboard.json` | Sample dashboard |
| `docker-compose.yml` | `implementation-manager/docker-compose.yml` | Reference compose with observability |

**Target Template Structure:**
- `compose.yml` - Docker Compose services (needs observability additions)
- `backend/app/main.py` - FastAPI app (needs observability integration)
- `backend/pyproject.toml` - Python dependencies (needs OTEL + prometheus-client)
- `cookiecutter.json` - Template configuration (needs include_observability variable)

### Backend Support Analysis (Complete)

**Current State:**
1. **Template `main.py`** (`/home/ty/workspace/project-starter/template/{{cookiecutter.project_slug}}/backend/app/main.py`):
   - FastAPI app properly structured with lifespan context manager
   - Middleware registration pattern established (CORS, TenantResolutionMiddleware)
   - Router registration pattern established
   - Exception handlers configured
   - **Gap**: No observability integration point

2. **Template `pyproject.toml`** (`/home/ty/workspace/project-starter/template/{{cookiecutter.project_slug}}/backend/pyproject.toml`):
   - Uses modern pyproject.toml format with hatchling
   - Dependencies section present
   - **Gap**: Missing OpenTelemetry and prometheus-client dependencies

3. **Source `observability.py`** (`/home/ty/workspace/project-starter/implementation-manager/backend/observability.py`):
   - Complete 104-line module
   - OpenTelemetry tracing setup (TracerProvider, OTLPSpanExporter, BatchSpanProcessor)
   - OpenTelemetry metrics setup (MeterProvider, OTLPMetricExporter)
   - Prometheus metrics (Counter, Histogram, Gauge)
   - FastAPIInstrumentor integration
   - HTTP metrics middleware
   - `/metrics` endpoint
   - Structured logging with trace context
   - Test mode detection via TESTING env var

4. **Template Backend Structure**:
   - `backend/app/` directory exists
   - `backend/app/core/config.py` handles settings
   - No existing observability module

**Needed Work:**
1. [ ] Create `backend/app/observability.py` template file
   - Port from implementation-manager
   - Add Jinja2 conditional wrapper for include_observability
   - Complexity: Low

2. [ ] Update `backend/app/main.py` template
   - Add conditional import for observability module
   - Add setup_observability(app) call after app creation, before middleware
   - Complexity: Low

3. [ ] Update `backend/pyproject.toml` template
   - Add conditional OpenTelemetry dependencies block
   - Add prometheus-client dependency
   - Complexity: Low

**Dependencies:**
- None for backend changes (self-contained)

**Recommended Approach:**
Port `observability.py` as-is with minimal templating. The source module is well-structured and meets all FR-BI requirements. Only changes needed:
- Change import path references if any
- Ensure environment variable defaults match template conventions

---

## Lateral Moves Identified
1. **OQ-008 Resolution Change**: FRD resolved to use "file-based log collection" but source promtail-config.yml still uses `docker_sd_configs` with Docker socket. Need to reconcile this.
   - Status: **Requires Review**
   - Impact: Promtail configuration will need modification

2. **Dashboard JSON Format**: Source backend-dashboard.json has minimal dashboard (4 panels). FRD specifies 4 complete dashboards with more panels.
   - Status: **Documented - Implementation will need to create additional dashboards**

## Open Issues
1. The source observability.py uses OTLP metric exporter (to Tempo), but Prometheus metrics are also defined. This is valid - Prometheus metrics are scraped via /metrics endpoint while OTLP metrics go to Tempo. Need to verify Tempo supports metrics ingestion or if this should be removed.

2. Health check endpoint trace exclusion (OQ-005 resolution) is not implemented in source observability.py. Will need to add SpanProcessor filter.

### Integration Points Analysis (Complete)

**Current State:**

1. **Docker Compose (`compose.yml`)**:
   - Template uses `{{ cookiecutter.project_slug }}-network` for all services
   - Existing services: postgres, keycloak, backend, frontend, redis
   - Volume naming pattern: `{{ cookiecutter.project_slug }}-*-data`
   - Restart policy: `unless-stopped` (consistent with FRD requirements)
   - Backend service has healthcheck configured

2. **Source Docker Compose (`implementation-manager/docker-compose.yml`)**:
   - Observability services properly configured (lines 91-160)
   - All services use same network pattern
   - Volume definitions present for prometheus-data, loki-data, tempo-data, grafana-data
   - Backend includes OTEL environment variables: `OTEL_EXPORTER_OTLP_ENDPOINT`, `OTEL_SERVICE_NAME`

3. **Network Configuration**:
   - All services communicate on internal Docker network
   - Prometheus scrapes backend:8000/metrics
   - Backend exports traces to tempo:4317 (gRPC)
   - Promtail pushes logs to loki:3100
   - Grafana connects to all three datasources

4. **Environment Variables (`.env.example`)**:
   - Well-structured with section comments
   - Missing: Observability section with port configurations
   - Missing: OTEL_* environment variables

**Needed Work:**

1. [ ] Add observability services to `compose.yml` with Jinja2 conditionals
   - prometheus, loki, promtail, tempo, grafana
   - Use {{ cookiecutter.project_slug }} prefix for container names
   - Add to existing network
   - Complexity: Medium

2. [ ] Add observability volumes to `compose.yml`
   - prometheus-data, loki-data, tempo-data, grafana-data
   - Conditional on include_observability
   - Complexity: Low

3. [ ] Add OTEL environment variables to backend service in `compose.yml`
   - OTEL_SERVICE_NAME: backend
   - OTEL_EXPORTER_OTLP_ENDPOINT: http://tempo:4317
   - Conditional on include_observability
   - Complexity: Low

4. [ ] Update `.env.example` with observability section
   - Add port configuration variables
   - Add OTEL environment variable documentation
   - Complexity: Low

**Key Integration Patterns:**
- Services use depends_on for startup ordering
- Promtail depends_on loki
- Grafana depends_on prometheus, loki, tempo
- Backend does NOT depend_on observability services (fail-open pattern per NFR-RL-001)

---

### Infrastructure Needs Analysis (Complete)

**Current State:**

1. **Template Directory Structure**:
   - No `observability/` directory exists in template
   - Backend app structure ready at `backend/app/`

2. **Source Observability Directory** (`implementation-manager/observability/`):
   ```
   observability/
   ├── grafana/
   │   ├── dashboards/
   │   │   ├── backend-dashboard.json
   │   │   └── dashboards.yml
   │   └── datasources/
   │       └── datasources.yml
   ├── loki/
   │   └── loki-config.yml
   ├── prometheus/
   │   └── prometheus.yml
   ├── promtail/
   │   └── promtail-config.yml
   ├── tempo/
   │   └── tempo.yml
   └── README.md
   ```

**Needed Work:**

1. [ ] Create `observability/` directory structure in template
   - Copy all subdirectories and files
   - Templatize prometheus.yml (cluster label)
   - Keep loki-config.yml as-is
   - Review promtail-config.yml for OQ-008 resolution (file-based vs Docker socket)
   - Keep tempo.yml as-is
   - Templatize datasources.yml if needed
   - Complexity: Medium

2. [ ] Create additional dashboards per FRD:
   - backend-dashboard.json (exists, needs enhancement)
   - slo-dashboard.json (new)
   - log-explorer-dashboard.json (new)
   - trace-explorer-dashboard.json (new)
   - Complexity: High (requires Grafana JSON expertise)

3. [ ] Create `observability/README.md` template
   - Port from implementation-manager
   - Templatize URLs with port variables
   - Complexity: Low

**Configuration File Analysis:**

| File | Template Variables Needed | Complexity |
|------|--------------------------|------------|
| prometheus.yml | `{{ cookiecutter.project_slug }}` for cluster label | Low |
| loki-config.yml | None | None |
| promtail-config.yml | Possibly update for file-based collection | Medium |
| tempo.yml | None | None |
| datasources.yml | None (uses internal DNS names) | None |
| dashboards.yml | None | None |
| backend-dashboard.json | None (uses Prometheus query language) | None |

---

### Template Conditional Rendering Analysis (Complete)

**Current State:**

1. **cookiecutter.json** (`/home/ty/workspace/project-starter/template/cookiecutter.json`):
   - 63 lines of existing configuration
   - No `include_observability` variable
   - No observability port variables
   - Uses `_copy_without_render` for certain file patterns

2. **Existing Conditional Patterns**:
   - Template uses standard Jinja2 `{{ cookiecutter.variable }}`
   - No examples of `{% if %}` conditionals in current template files

**Needed Work:**

1. [ ] Add variables to `cookiecutter.json`:
   ```json
   "include_observability": "yes",
   "grafana_port": "3000",
   "prometheus_port": "9090",
   "loki_port": "3100",
   "tempo_http_port": "3200",
   "tempo_otlp_grpc_port": "4317",
   "tempo_otlp_http_port": "4318"
   ```
   - Complexity: Low

2. [ ] Implement conditional file generation:
   - Option A: Jinja2 `{% if %}` blocks in compose.yml (recommended)
   - Option B: Post-generation hooks to remove files
   - FRD specifies Jinja2 conditionals (FR-TC-003)
   - Complexity: Medium

3. [ ] Conditional observability directory:
   - Cookiecutter does not natively support conditional directories
   - Need post-generation hook in `hooks/post_gen_project.py`
   - Hook removes observability/ if include_observability == "no"
   - Complexity: Medium

4. [ ] Conditional in `main.py`:
   - Use `{% if cookiecutter.include_observability == "yes" %}`
   - Wrap import and setup_observability() call
   - Complexity: Low

5. [ ] Conditional in `pyproject.toml`:
   - Add OTEL dependencies inside conditional block
   - Complexity: Low

6. [ ] Conditional in README.md:
   - Add Observability section with conditional wrapper
   - Complexity: Low

7. [ ] Conditional in `.env.example`:
   - Add Observability section with conditional wrapper
   - Complexity: Low

---

## Lateral Moves Identified

1. **OQ-008 Resolution Change**: FRD resolved to use "file-based log collection" but source promtail-config.yml still uses `docker_sd_configs` with Docker socket. Need to reconcile this.
   - Status: **Requires Decision**
   - Options:
     a. Modify promtail-config.yml to use file-based collection only (aligns with OQ-008)
     b. Keep Docker socket approach (works but has security concerns)
     c. Document both approaches, default to file-based
   - **Recommendation**: Option (c) - Keep current config as it works, document security trade-off per SEC-012

2. **Dashboard JSON Format**: Source backend-dashboard.json has minimal dashboard (4 panels). FRD specifies 4 complete dashboards with more panels.
   - Status: **Documented - Implementation will need to create additional dashboards**
   - This is implementation work, not a blocker for FRD refinement

3. **Post-Generation Hook**: Need to modify `hooks/post_gen_project.py` for conditional directory removal
   - Status: **Confirmed - Hook exists at `/home/ty/workspace/project-starter/hooks/post_gen_project.py`**
   - Current hook handles: script permissions, .env creation, uv.lock generation, git initialization
   - Need to add: observability directory removal when include_observability == "no"
   - Impact: Low - straightforward addition to existing hook

## Open Issues

1. **OTLP Metrics to Tempo**: The source observability.py uses OTLP metric exporter sending to Tempo, but Tempo is primarily a tracing backend. The Prometheus metrics are also defined and scraped via /metrics endpoint. This dual approach may be intentional for different metrics destinations.
   - **Resolution**: Keep both. OTLP metrics are experimental, Prometheus scraping is the primary metrics collection. The OTLP exporter to Tempo can be documented as optional/future-proofing.

2. **Health Check Trace Exclusion**: OQ-005 resolution specifies excluding /api/v1/health from tracing for cleaner traces. This is not implemented in source observability.py.
   - **Resolution**: Add to implementation tasks. Not a blocker for FRD but should be noted in implementation pathway.

## Final Status

**All concerns analyzed. FRD marked as "Codebase Aligned and Ready for Task Breakdown".**

### Summary of Findings

1. **Backend Support**: Complete reference implementation exists in `implementation-manager/backend/observability.py`. Port-and-adapt approach is straightforward with low complexity.

2. **Docker Compose Integration**: Template compose.yml follows consistent patterns. Observability services can be added with Jinja2 conditionals. Fail-open pattern (no backend dependency on observability) is critical.

3. **Infrastructure**: Need to create `observability/` directory with config files from implementation-manager. Post-generation hook already exists and can be extended for conditional file removal.

4. **Template Conditionals**: This will be the first use of `{% if %}` patterns in the template. Recommend hybrid approach: inline Jinja2 for compose/main/pyproject, post-gen hook for directory/file removal.

### Implementation Complexity

- **Overall**: Medium
- **Estimated Effort**: 7-10 days
- **Critical Path**: cookiecutter.json -> observability directory -> backend instrumentation -> Docker Compose -> testing

### Recommendations

1. Keep Docker socket approach for Promtail (simpler, document security per SEC-012)
2. Phase dashboard creation: start with existing backend-dashboard.json, add others as follow-up
3. Ensure first {% if %} implementation sets clean precedent for template

### Files Modified

Added to FRD (`/home/ty/workspace/project-starter/docs/futures/observability-stack-integration.md`):
- Implementation Analysis: Backend Support
- Implementation Analysis: Docker Compose Integration
- Implementation Analysis: Infrastructure and Template Conditionals
- Implementation Analysis: Complexity Assessment
- Codebase Alignment Status

---

*Refinement Complete: 2025-12-03*
