# Refinement Tracking: Production Essentials FRD

**FRD Path:** `/home/ty/workspace/project-starter/docs/futures/production-essentials.md`
**Refiner Started:** 2025-12-05
**Status:** Codebase Aligned and Ready for Task Breakdown

---

## Analysis Progress

- [x] Initial FRD review and codebase scan
- [x] Backend support analysis (Dockerfiles, config, observability)
- [x] CI/CD integration points analysis
- [x] Kubernetes deployment requirements analysis
- [x] Security hardening implementation pathways
- [x] Database backup and operational requirements
- [x] Frontend patterns and load testing integration
- [x] Final consolidation and FRD update

---

## Current Focus

**ALL ANALYSES COMPLETE - Ready for FRD Update**

---

## Codebase Structure Summary

### Template Location
```
/home/ty/workspace/project-starter/template/{{cookiecutter.project_slug}}/
```

### Key Backend Files
- `backend/Dockerfile` - Multi-stage with development AND production targets (already exists)
- `backend/app/main.py` - FastAPI entry point with middleware chain
- `backend/app/core/config.py` - Pydantic settings (extensible)
- `backend/app/observability.py` - OpenTelemetry + Prometheus metrics (when enabled)
- `backend/app/middleware/tenant.py` - Tenant resolution middleware pattern

### Key Infrastructure Files
- `compose.yml` - Docker Compose with conditional observability
- `template/cookiecutter.json` - Cookiecutter variables (include_observability pattern exists)
- `observability/prometheus/prometheus.yml` - Prometheus configuration

### Existing ADRs (18 documented)
- ADR-017: Optional Observability Stack (pattern for optional features)
- ADR-005: Row-Level Security for Multi-tenancy
- ADR-014: Rate Limiting Strategy
- ADR-015: CORS Configuration

---

## Findings Summary

### 1. Backend Support Analysis

#### Current State - STRONG ALIGNMENT

**Dockerfiles (FRD Concern: "only development targets")**
- **FINDING: FRD is INCORRECT** - Production targets already exist in both Dockerfiles
- Backend Dockerfile has 4 stages: `base`, `dependencies`, `development`, `production`
- Production stage includes: non-root user (appuser), proper WORKDIR, 4 uvicorn workers
- Frontend Dockerfile has 3 stages: `development`, `build`, `production` (nginx)
- **Gap:** Production stages could be enhanced with HEALTHCHECK instructions

**Configuration Management (`config.py`)**
- Pydantic-settings based, environment variable driven
- Missing: Security header settings (CSP, HSTS, X-Frame-Options)
- Missing: Sentry DSN and configuration
- Missing: Backup-related settings
- **Extensible:** Easy to add new settings following existing patterns

**Observability Stack**
- Comprehensive implementation exists when `include_observability == "yes"`
- OpenTelemetry tracing to Tempo
- Prometheus metrics with counters, histograms, gauges
- `/metrics` endpoint exposed
- **Gap:** No alerting rules file (`alerts.yml`) - only scrape config exists
- **Gap:** No alert manager configuration

**Middleware Chain**
- CORS middleware configured
- Tenant resolution middleware implemented
- **Gap:** No security headers middleware exists
- **Integration Point:** Security headers middleware should be added after CORS, similar to tenant middleware pattern

**Health Endpoints**
- `/api/v1/health` - Basic liveness check
- `/api/v1/ready` - Readiness check (exists but doesn't check DB/Redis)
- **Gap:** Readiness endpoint should verify database and Redis connectivity

### Implementation Pathways Identified

| FRD Requirement | Pathway | Complexity |
|-----------------|---------|------------|
| Production Dockerfiles | Already exist - minor enhancements | Low |
| Security headers middleware | New middleware file, register in main.py | Medium |
| Security header config | Add settings to config.py | Low |
| Prometheus alerts | New `alerts.yml` file, update prometheus.yml | Medium |
| Sentry integration | New optional module, cookiecutter conditional | Medium |
| Health endpoint enhancement | Modify existing health.py router | Low |

### Lateral Moves Identified

1. **Health Endpoint Enhancement** (Non-destructive)
   - Current readiness check returns static response
   - Should verify database pool and Redis connectivity
   - Rationale: Kubernetes probes need accurate health status

2. **Observability Module Extension** (Additive)
   - Current `observability.py` handles tracing/metrics
   - Could add Sentry setup function as optional integration
   - Follows existing pattern of conditional observability

---

## Concerns to Analyze (Remaining)

### CI/CD Integration Points
- No `.github/workflows/` directory exists
- Need to verify template generation handles workflow files
- Check if dependabot.yml pattern exists

### Kubernetes Deployment
- No `k8s/` directory exists in template
- Will need full directory structure creation
- Should follow kustomize base/overlay pattern

### Security Hardening
- Pre-commit configuration does not exist in template
- Need gitleaks integration pattern
- CSP policy design for Lit components

### Database Backup
- No backup scripts exist
- Need pg_dump wrapper with retention
- Consider S3 upload option

### Frontend/Load Testing
- k6 scripts do not exist
- TypeScript API client generation not configured
- Frontend observability (Sentry browser SDK)

---

## Lateral Moves Requiring Approval

### LM-1: Health Endpoint Database/Redis Check
**Description:** Enhance `/api/v1/ready` to actually verify database and Redis connectivity
**Impact:** Low risk, improves Kubernetes probe accuracy
**Status:** Documented - can proceed without explicit approval

### LM-2: Observability Module Sentry Extension
**Description:** Add optional Sentry setup within observability module or as separate module
**Impact:** Additive, follows existing optional feature pattern
**Status:** Documented - follows ADR-017 pattern

---

## Next Steps

1. ~~Backend support analysis~~ COMPLETE
2. **CI/CD Integration Points** - Analyze GitHub Actions requirements
3. **Kubernetes Deployment** - Define manifest structure
4. **Security Hardening** - CSP policy, gitleaks, middleware
5. **Database Backup** - Script design, CronJob pattern
6. **Frontend/Load Testing** - k6 scripts, API client generation
7. **Final Consolidation** - Update FRD with implementation sections

---

## Session Log

### Session 1 - 2025-12-05
- Initial FRD read (comprehensive, 78 requirements)
- Codebase structure exploration
- Backend Dockerfile analysis: CORRECTION - production targets exist
- Config.py analysis: Identified extension points
- Observability.py analysis: Strong foundation, missing alerting
- Health endpoint analysis: Needs enhancement
- Created refinement tracking document

---

## Complete Analysis Findings

### 2. CI/CD Integration Points Analysis

#### Current State - GREENFIELD (No existing CI/CD)

**Findings:**
- No `.github/workflows/` directory exists in template
- No CI/CD configuration files anywhere in template
- No dependabot.yml configuration
- No pre-commit configuration file (`.pre-commit-config.yaml`)

**Supporting Infrastructure for CI:**
- `pyproject.toml` has complete pytest and ruff configuration
- `package.json` has lint, test, and build scripts ready
- `.env.test` exists for test environment configuration
- Docker services (postgres, redis) can be replicated in CI

**Implementation Pathway:**
| Component | Approach | Complexity |
|-----------|----------|------------|
| `.github/workflows/ci.yml` | New file, use service containers | Medium |
| `.github/workflows/build.yml` | New file, multi-platform builds | Medium |
| `.github/workflows/deploy.yml` | New file, Kubernetes deployment | Medium |
| `.github/workflows/security.yml` | New file, Trivy + pip-audit | Medium |
| `.github/dependabot.yml` | New file | Low |
| Workflow cookiecutter conditionals | Follow `include_observability` pattern | Medium |

**Key CI Commands Available:**
- Backend: `uv sync && pytest --cov=app && ruff check .`
- Frontend: `npm ci && npm test && npm run lint && npm run build`

---

### 3. Kubernetes Deployment Requirements

#### Current State - GREENFIELD (No K8s manifests)

**Findings:**
- No `k8s/` directory exists
- No Kubernetes manifests anywhere in template
- compose.yml provides the deployment structure to mirror

**Services to Deploy (from compose.yml analysis):**
1. **backend** - FastAPI, port 8000, depends on postgres, redis, keycloak
2. **frontend** - nginx, port 80
3. External dependencies: PostgreSQL, Redis, Keycloak (typically managed services in prod)

**Existing Patterns to Leverage:**
- Health check endpoints already defined (`/api/v1/health`, `/api/v1/ready`)
- Environment variable configuration pattern in config.py
- Docker health check patterns in compose.yml

**Implementation Pathway:**
| Manifest | Details | Complexity |
|----------|---------|------------|
| `k8s/base/backend-deployment.yaml` | Deployment with health probes, env vars | Medium |
| `k8s/base/backend-service.yaml` | ClusterIP service, port 8000 | Low |
| `k8s/base/frontend-deployment.yaml` | Deployment with nginx | Low |
| `k8s/base/frontend-service.yaml` | ClusterIP service, port 80 | Low |
| `k8s/base/ingress.yaml` | Ingress with TLS template | Medium |
| `k8s/base/configmap.yaml` | Non-sensitive config | Low |
| `k8s/overlays/staging/` | Staging-specific patches | Low |
| `k8s/overlays/production/` | Production replicas/resources | Low |
| Cookiecutter conditional `include_kubernetes` | Follow observability pattern | Medium |

---

### 4. Security Hardening Implementation Pathways

#### Current State - PARTIAL (Some security exists)

**Existing Security Features:**
- Frontend nginx.conf has `X-Frame-Options`, `X-Content-Type-Options`, `X-XSS-Protection`
- Backend has CORS middleware with configurable origins
- Rate limiting via Redis (ADR-014)
- OAuth 2.0 with PKCE
- Row-Level Security for multi-tenancy

**Gaps Identified:**
- **Backend security headers middleware** - Does not exist
- **Pre-commit hooks** - No `.pre-commit-config.yaml`
- **Secrets detection** - No gitleaks configuration
- **CSP policy** - Not configured for backend responses
- **HSTS** - Not configured

**nginx.conf Already Has (Frontend):**
```
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
```

**Implementation Pathway:**
| Component | Location | Complexity |
|-----------|----------|------------|
| `SecurityHeadersMiddleware` | `backend/app/middleware/security_headers.py` | Medium |
| Security config settings | `backend/app/core/config.py` | Low |
| Register middleware | `backend/app/main.py` | Low |
| `.pre-commit-config.yaml` | Template root | Medium |
| `.gitleaks.toml` | Template root | Low |
| `docs/SECURITY_CHECKLIST.md` | Template docs | Medium |

**CSP Policy Considerations:**
- Lit components use inline styles/scripts - need `'unsafe-inline'` for script-src
- OAuth flows need connect-src to include Keycloak URL
- Frame-ancestors 'none' for API, 'self' for frontend

---

### 5. Database Backup and Operational Requirements

#### Current State - NONE

**Findings:**
- No backup scripts exist in `scripts/` directory
- Only script is `docker-dev.sh` and `init-db.sql`
- No cron job configurations
- No recovery documentation

**Existing Infrastructure:**
- PostgreSQL version configurable via cookiecutter
- Dual-user model (migration user with BYPASSRLS)
- Database connection strings in config

**Implementation Pathway:**
| Component | Location | Complexity |
|-----------|----------|------------|
| `scripts/backup-db.sh` | Template scripts | Medium |
| `scripts/restore-db.sh` | Template scripts | Medium |
| `k8s/base/backup-cronjob.yaml` | K8s CronJob | Medium |
| `docs/runbooks/database-recovery.md` | Template docs | Medium |
| `docs/runbooks/incident-response.md` | Template docs | Medium |

**Backup Script Requirements:**
- Use pg_dump with compression
- Support S3 upload (optional)
- Configurable retention (BACKUP_RETENTION_DAYS)
- Use migration user credentials (BYPASSRLS)

---

### 6. Frontend Patterns and Load Testing Integration

#### Current State - PARTIAL

**Frontend Patterns Available:**
- Complete OpenTelemetry instrumentation in frontend
- Vitest for unit tests
- Playwright for E2E tests
- TypeScript API client exists (`frontend/src/api/`)

**Gaps:**
- No k6 load testing scripts
- No API client generation from OpenAPI
- No Sentry browser SDK integration

**Implementation Pathway:**
| Component | Location | Complexity |
|-----------|----------|------------|
| `k6/load-test.js` | Template root | Medium |
| `k6/scenarios/` | Various load test scenarios | Medium |
| OpenAPI Generator config | `frontend/openapitools.json` | Medium |
| Sentry browser SDK | `frontend/src/sentry.ts` (optional) | Medium |

**k6 Scripts Should Test:**
- `/api/v1/health` - High volume, baseline
- `/api/v1/auth/me` - Authenticated requests
- Full OAuth flow - Complex scenario

---

### 7. Prometheus Alerting Rules

#### Current State - PARTIAL

**Existing:**
- `prometheus.yml` has scrape configuration for 5 jobs
- Metrics exposed at `/metrics` endpoint
- No alerting rules defined

**Implementation Pathway:**
| Component | Location | Changes |
|-----------|----------|---------|
| `observability/prometheus/alerts.yml` | New file | Create alert rules |
| `prometheus.yml` update | Existing file | Add `rule_files` reference |
| Alertmanager (optional) | `observability/alertmanager/` | Full new directory |

**Required Alerts (per FRD):**
- HighErrorRate: 5xx > 1% for 5 minutes
- HighLatency: p95 > 2 seconds for 5 minutes
- DatabaseConnectionPoolExhausted
- RedisConnectionFailure

---

## FRD Corrections Required

### 1. Dockerfile Assessment is INCORRECT
The FRD states: "Dockerfiles exist but only with development targets"

**CORRECTION:** Both backend and frontend Dockerfiles already have production targets:
- Backend: `FROM dependencies AS production` with non-root user, 4 workers
- Frontend: `FROM nginx:alpine AS production`

**FRD Update Required:** Change Problem Statement to note production targets exist but could be enhanced with HEALTHCHECK instructions.

### 2. nginx.conf Already Has Security Headers
The FRD implies no security headers exist for frontend.

**CORRECTION:** `frontend/nginx.conf` already includes:
- X-Frame-Options: SAMEORIGIN
- X-Content-Type-Options: nosniff
- X-XSS-Protection: 1; mode=block

**FRD Update Required:** Note frontend has partial coverage; backend needs middleware.

---

## Implementation Complexity Summary

| Phase | FRD Estimate | Refined Estimate | Notes |
|-------|--------------|------------------|-------|
| Phase 1: CI/CD | 2-3 weeks | 2 weeks | Good infrastructure exists |
| Phase 2: Security | 2 weeks | 1.5 weeks | Partial exists (nginx) |
| Phase 3: Operational | 2-3 weeks | 2 weeks | Greenfield |
| Phase 4: Kubernetes | 2 weeks | 2 weeks | Greenfield |
| Phase 5: DX (k6, etc) | 2 weeks | 1.5 weeks | API client exists |
| Phase 6: Docs | 1-2 weeks | 1 week | ADR pattern established |

**Total Refined Estimate:** 10-11 weeks (vs FRD's 10-14 weeks)

---

## Lateral Moves Summary

| ID | Description | Risk | Approval |
|----|-------------|------|----------|
| LM-1 | Enhance `/api/v1/ready` with DB/Redis checks | Low | Proceed |
| LM-2 | Add Sentry as optional module | Low | Follows ADR-017 |
| LM-3 | Add HEALTHCHECK to Dockerfiles | Low | Proceed |
| LM-4 | Enhance nginx.conf CSP headers | Low | Proceed |

---

## Recommended Implementation Order

1. **Phase 1: CI/CD Foundation** - Start here, enables all other phases
2. **Phase 2: Security Hardening** - Backend middleware, pre-commit
3. **Phase 3: Kubernetes** - Depends on Phase 1 for CI deployment
4. **Phase 4: Operational** - Alerting, backup scripts
5. **Phase 5: DX** - Load testing, API versioning docs
6. **Phase 6: Documentation** - ADRs, runbooks

---

## Status: CODEBASE ALIGNED - Ready for Task Breakdown

The FRD is comprehensive and largely accurate with the corrections noted above. The codebase has strong foundations that support the proposed implementation:

- Existing cookiecutter conditional pattern (`include_observability`) provides blueprint for optional features
- Observability stack provides foundation for alerting rules
- Configuration management is extensible
- Testing infrastructure is complete
- Docker production targets already exist (minor enhancements needed)
